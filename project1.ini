import streamlit as st
import googlemaps
from math import sin, cos, sqrt, atan2, radians

# Google Maps API ì„¤ì • (ë³¸ì¸ì˜ API í‚¤ë¡œ êµì²´ í•„ìš”)
API_KEY = "YOUR_GOOGLE_MAPS_API_KEY"
gmaps = googlemaps.Client(key=API_KEY)

# ì§ˆë¬¸ ë° ë‹µë³€ ë°ì´í„° ì •ì˜
questions = [
    {"question": "ì˜¤ëŠ˜ ê¸°ë¶„ì´ ì–´ë– ì‹ ê°€ìš”?", "answers": ["ë§¤ìš° ì¢‹ìŒ", "ë³´í†µ", "ë³„ë¡œ ì¢‹ì§€ ì•ŠìŒ"]},
    {"question": "ì‚¬ëŒë“¤ê³¼ í•¨ê»˜ ìˆì„ ë•Œ ì—ë„ˆì§€ê°€ ì¶©ì „ë˜ë‚˜ìš”?", "answers": ["ë§¤ìš° ê·¸ë ‡ë‹¤", "ë³´í†µì´ë‹¤", "ì•„ë‹ˆë‹¤"]},
    {"question": "í™œë™ì ì¸ ê²ƒì„ ì¢‹ì•„í•˜ì‹œë‚˜ìš”?", "answers": ["ë§¤ìš° ì¢‹ì•„í•¨", "ë³´í†µ", "ì„ í˜¸í•˜ì§€ ì•ŠìŒ"]},
    {"question": "ì°½ì˜ì ì¸ í™œë™ì„ ì¦ê¸°ì‹œë‚˜ìš”?", "answers": ["ë§¤ìš° ì¢‹ì•„í•¨", "ë³´í†µ", "ì„ í˜¸í•˜ì§€ ì•ŠìŒ"]},
    {"question": "ê²½ìŸì ì¸ í™œë™ì„ ì„ í˜¸í•˜ì‹œë‚˜ìš”?", "answers": ["ë§¤ìš° ì¢‹ì•„í•¨", "ë³´í†µ", "ì„ í˜¸í•˜ì§€ ì•ŠìŒ"]},
    {"question": "í˜„ì¬ ìŠ¤íŠ¸ë ˆìŠ¤ ìˆ˜ì¤€ì€ ì–´ë– ì‹ ê°€ìš”?", "answers": ["ë§ì´ ë°›ê³  ìˆìŒ", "ë³´í†µ", "ê±°ì˜ ì—†ìŒ"]},
    {"question": "ì‹¤ë‚´ì™€ ì‹¤ì™¸ í™œë™ ì¤‘ ì–´ë–¤ ê²ƒì„ ì„ í˜¸í•˜ì‹œë‚˜ìš”?", "answers": ["ì‹¤ì™¸", "ë‘˜ ë‹¤ ì¢‹ìŒ", "ì‹¤ë‚´"]},
    {"question": "ìƒˆë¡œìš´ ê²ƒì„ ë°°ìš°ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ì‹œë‚˜ìš”?", "answers": ["ë§¤ìš° ì¢‹ì•„í•¨", "ë³´í†µ", "ì„ í˜¸í•˜ì§€ ì•ŠìŒ"]},
    {"question": "í˜¼ì í•˜ëŠ” í™œë™ê³¼ ë‹¨ì²´ í™œë™ ì¤‘ ì–´ë–¤ ê²ƒì„ ì„ í˜¸í•˜ì‹œë‚˜ìš”?", "answers": ["ë‹¨ì²´ í™œë™", "ë‘˜ ë‹¤ ì¢‹ìŒ", "í˜¼ì í•˜ëŠ” í™œë™"]},
    {"question": "ì§€ê¸ˆ ë‹¹ì¥ í•˜ê³  ì‹¶ì€ í™œë™ì˜ ê°•ë„ëŠ”?", "answers": ["í™œë°œí•œ í™œë™", "ì ë‹¹í•œ í™œë™", "ì¡°ìš©í•œ í™œë™"]},
]

plays = {
    "active_group": [
        {"title": "í’‹ì‚´", "description": "ì¢ì€ ê³µê°„ì—ì„œë„ ì¦ê¸¸ ìˆ˜ ìˆëŠ” ë¯¸ë‹ˆ ì¶•êµ¬ì…ë‹ˆë‹¤.", "emoji": "âš½"},
        {"title": "í‚¨ë³¼", "description": "ì„¸ íŒ€ì´ ê²½ìŸí•˜ëŠ” ëŒ€í˜• ê³µ ìŠ¤í¬ì¸ ì…ë‹ˆë‹¤.", "emoji": "ğŸˆ"},
        {"title": "ì–¼í‹°ë¯¸íŠ¸ í”„ë¦¬ìŠ¤ë¹„", "description": "í”„ë¦¬ìŠ¤ë¹„ë¡œ ì¦ê¸°ëŠ” ë¹„ì ‘ì´‰ íŒ€ ìŠ¤í¬ì¸ ì…ë‹ˆë‹¤.", "emoji": "ğŸ¥"}
    ],
    "creative_indoor": [
        {"title": "ê·¸ë¦¼ ê·¸ë¦¬ê¸° ëŒ€íšŒ", "description": "í•¨ê»˜ ê·¸ë¦¼ì„ ê·¸ë¦¬ê³  ì‘í’ˆì„ ê°ìƒí•´ë³´ì„¸ìš”.", "emoji": "ğŸ¨"},
        {"title": "ë³´ë“œê²Œì„", "description": "ì „ëµì  ì‚¬ê³ ì™€ ì¬ë¯¸ë¥¼ ë™ì‹œì— ì¦ê¸°ì„¸ìš”.", "emoji": "ğŸ²"}
    ],
    "relaxing_solo": [
        {"title": "ë…ì„œì™€ ìŒì•…ê°ìƒ", "description": "ì¡°ìš©íˆ ì±…ì„ ì½ê±°ë‚˜ ìŒì•…ì„ ë“¤ì–´ë³´ì„¸ìš”.", "emoji": "ğŸ“š"},
        {"title": "ëª…ìƒê³¼ ìš”ê°€", "description": "ìš”ê°€ì™€ ëª…ìƒìœ¼ë¡œ ë§ˆìŒì˜ ì•ˆì •ì„ ì°¾ì•„ë³´ì„¸ìš”.", "emoji": "ğŸ§˜"}
    ]
}

# ì‚¬ìš©ìê°€ ë‹µë³€í•œ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§ì¶¤í˜• ë†€ì´ ì¶”ì²œ
def recommend_play(answers):
    extroversion_score = answers[1]
    mood_score = answers[0]
    activity_preference = answers[2]

    if extroversion_score == 0 and activity_preference == 0:
        return plays["active_group"]
    elif mood_score == 2:
        return plays["relaxing_solo"]
    else:
        return plays["creative_indoor"]

# Streamlit ì•± ì‹œì‘
st.title("ì˜¤ëŠ˜ì˜ ë†€ì´ ì¶”ì²œ ğŸ®")
st.write("ëª‡ ê°€ì§€ ì§ˆë¬¸ì— ë‹µí•˜ê³  ë§ì¶¤í˜• ë†€ì´ë¥¼ ì¶”ì²œë°›ì•„ë³´ì„¸ìš”!")

user_answers = []

# ì§ˆë¬¸ í‘œì‹œ
for idx, question in enumerate(questions):
    st.write(f"**{question['question']}**")
    answer = st.radio("", question["answers"], key=f"q{idx}")
    user_answers.append(question["answers"].index(answer))

# ë†€ì´ ì¶”ì²œ ê²°ê³¼ í‘œì‹œ
if st.button("ì¶”ì²œë°›ê¸°"):
    recommendations = recommend_play(user_answers)
    st.subheader("ë‹¹ì‹ ì„ ìœ„í•œ ë†€ì´ ì¶”ì²œ")
    for play in recommendations:
        st.write(f"{play['emoji']} **{play['title']}**")
        st.write(play["description"])

# ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜
def calculate_distance(lat1, lon1, lat2, lon2):
    R = 6371  # ì§€êµ¬ ë°˜ì§€ë¦„ (km)
    dlat = radians(lat2 - lat1)
    dlon = radians(lon2 - lon1)
    a = sin(dlat / 2) ** 2 + cos(radians(lat1)) * cos(radians(lat2)) * sin(dlon / 2) ** 2
    c = 2 * atan2(sqrt(a), sqrt(1 - a))
    return R * c

# í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ ì¶”ì²œ ì¥ì†Œ í‘œì‹œ
if st.button("ì£¼ë³€ ì¥ì†Œ ì°¾ê¸°"):
    location = st.text_input("í˜„ì¬ ìœ„ì¹˜ (ìœ„ë„, ê²½ë„ í˜•íƒœë¡œ ì…ë ¥)", "37.5665,126.9780")
    lat, lng = map(float, location.split(","))
    search_type = st.selectbox("ì°¾ê³  ì‹¶ì€ ì¥ì†Œ ìœ í˜•", ["ê³µì›", "ë³´ë“œê²Œì„ ì¹´í˜", "ìš´ë™ì¥"])

    # Google Maps APIë¡œ ì¥ì†Œ ê²€ìƒ‰
    places_result = gmaps.places_nearby(location=(lat, lng), radius=5000, keyword=search_type)
    st.subheader("ì£¼ë³€ ì¶”ì²œ ì¥ì†Œ")
    for place in places_result["results"][:5]:
        place_name = place["name"]
        place_address = place["vicinity"]
        distance = calculate_distance(lat, lng, place["geometry"]["location"]["lat"], place["geometry"]["location"]["lng"])
        st.write(f"**{place_name}** - {place_address} ({distance:.1f}km)")

